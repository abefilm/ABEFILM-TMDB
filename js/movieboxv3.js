(()=>{document.addEventListener("DOMContentLoaded",()=>{function Y(P){let J={};async function _(){try{let[R,s]=await Promise.all([fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${P}&language=en-US`).then(d=>d.json()),fetch(`https://api.themoviedb.org/3/genre/tv/list?api_key=${P}&language=en-US`).then(d=>d.json())]);[...R.genres||[],...s.genres||[]].forEach(d=>J[d.id]=d.name)}catch(R){console.error("Failed to load genres:",R)}}let D=document.querySelector(".search-input"),C=document.getElementById("search-results");if(D&&C){let s=function(i){C.innerHTML="";let h=i.filter(E=>["movie","tv"].includes(E.media_type)&&E.poster_path).slice(0,6);if(h.length===0){C.style.display="none";return}h.forEach(async E=>{let x=E.title||E.name||"Untitled",H=`https://image.tmdb.org/t/p/w92${E.poster_path}`,O=(E.release_date||E.first_air_date||"").split("-")[0]||"N/A",F=E.media_type==="movie"?"Movie":"TV Show",w=document.createElement("li");w.innerHTML=`
                        <img src="${H}" alt="${x}">
                        <div class="search-info">
                            <p>${x}</p>
                            <small>${F} | ${O}</small>
                        </div>`,w.addEventListener("click",()=>{window.location.href=`/p/details.html?id=${E.id}&type=${E.media_type}`}),C.appendChild(w)}),C.style.display="block"};var q=s;async function R(i){let h=`https://api.themoviedb.org/3/search/multi?api_key=${P}&query=${encodeURIComponent(i)}&language=en-US`;try{return(await(await fetch(h)).json()).results||[]}catch{return[]}}let d;D.addEventListener("input",()=>{let i=D.value.trim();clearTimeout(d),d=setTimeout(async()=>{if(i.length>=2){let h=await R(i);s(h)}else C.style.display="none"},300)}),document.addEventListener("click",i=>{i.target.closest(".search-container")||(C.style.display="none")})}let z=document.getElementById("library");if(z){let S=function(){let B=new Date().getFullYear();for(let k=B;k>=1950;k--)O.innerHTML+=`<option value="${k}">${k}</option>`;F.innerHTML+=Object.entries(J).map(([k,c])=>`<option value="${k}">${c}</option>`).join(""),[x,H,O,F,w,I].forEach(k=>{k.addEventListener("change",()=>{R=1,T(!0)})})},T=function(B=!1){if(d)return;d=!0,B&&(E.innerHTML="");let k=x.value,c=O.value,a=F.value,u=w.value,g=h.value.trim(),f=I.value,r=g.length>=2,L=r?`https://api.themoviedb.org/3/search/${k}?api_key=${P}&language=en-US&query=${encodeURIComponent(g)}&page=${R}`:`https://api.themoviedb.org/3/discover/${k}?api_key=${P}&language=en-US&sort_by=popularity.desc&page=${R}`;f&&(L+=`&vote_average.gte=${f}`),r||(c&&(L+=`&primary_release_year=${c}`),a&&(L+=`&with_genres=${a}`),u&&(L+=`&with_origin_country=${u}`)),fetch(L).then(v=>v.json()).then(v=>{if(!v.results||v.results.length===0){R===1&&(E.innerHTML="<p>No results found.</p>"),d=!1;return}s=v.total_pages;let j=v.results.map((y,o)=>{let n=y.title||y.name||"Untitled",p=(y.release_date||y.first_air_date||"").split("-")[0]||"N/A",m=y.vote_average?y.vote_average.toFixed(1):"N/A",$=(y.genre_ids||[]).map(t=>J[t]).filter(Boolean).join(", ")||"N/A",A=y.overview?y.overview.slice(0,160)+"\u2026":"No overview available.",M=(R-1)*20+o+1;return`
                        <div class="movie-card" data-id="${y.id}" data-type="${k}">
                            <div class="movie-thumbnail">
                              <img src="${y.poster_path?`https://image.tmdb.org/t/p/w300${y.poster_path}`:"https://i.imgur.com/YyHsyEr.png"}" alt="${n}">
                              <div class="movie-rank rank-${M<=10?M:"default"}">${M}</div>
                            </div>
                            <div class="movie-info">
                              <div>
                                <div class="movie-title">${n}</div>
                                <div class="movie-meta">${k.charAt(0).toUpperCase()+k.slice(1)} \u2022 ${m} \u2022 ${p}</div>
                                <div class="movie-genres"><span>${$}</span></div>
                                <div class="movie-overview">${A}</div>
                              </div>
                              <div class="movie-actions">
                               <button class="play-button" onclick="window.location.href='/p/details.html?id=${y.id}&type=${k}'">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M18.89 12.85c-.35 1.34-2.02 2.29-5.36 4.19-3.23 1.84-4.84 2.76-6.14 2.42a4.3 4.3 0 0 1-1.42-.84C5 17.61 5 15.74 5 12s0-5.61.97-6.58c.4-.4.9-.69 1.43-.83 1.3-.37 2.91.55 6.14 2.4 3.34 1.9 5.01 2.85 5.36 4.19.15.55.15 1.14 0 1.67Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
                                  Play
                                </button>
                              </div>
                            </div>
                          </div>`}).join("");E.insertAdjacentHTML("beforeend",j),d=!1}).catch(v=>{E.innerHTML="<p>Error loading content.</p>",console.error(v),d=!1})},Z=function(){d||R>=s||window.scrollY+window.innerHeight>=document.body.offsetHeight-400&&(R++,T())};var G=S,ee=T,Q=Z;let R=1,s=1,d=!1,i,h=document.getElementById("search-bar"),E=document.getElementById("library-content"),x=document.getElementById("type-filter"),H=document.getElementById("status-filter"),O=document.getElementById("year-filter"),F=document.getElementById("genre-filter"),w=document.getElementById("country-filter"),I=document.getElementById("rating-filter");S(),T(!0),window.addEventListener("scroll",Z),h.addEventListener("input",()=>{clearTimeout(i),i=setTimeout(()=>{R=1,T(!0)},400)})}_().then(()=>{z&&initializeLibrary(P)})}function K(){let P=0,J=50,_=setInterval(()=>{window.apiKey?(clearInterval(_),Y(window.apiKey)):P++>=J&&(clearInterval(_),console.error("API Key (window.apiKey) was not found. Search/Library will not function."))},100)}K()});document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",function(s){if(s.target.classList.contains("scroll-btn")||s.target.classList.contains("cast-scroll-btn")||s.target.classList.contains("tmdb-scroll")){let i=s.target.closest(".cast-scroll-wrapper, .tmdb-wrapper")?.querySelector(".cast-scroll, .tmdb-row");if(i){let h=s.target.classList.contains("left")?-1:1,E=i.clientWidth;i.scrollBy({left:h*E,behavior:"smooth"})}}});let Y;function K(){if(document.getElementById("custom-toast-notification"))return;let s=document.createElement("div");s.id="custom-toast-notification",document.body.appendChild(s)}function P(s,d="info"){let i=document.getElementById("custom-toast-notification");i&&(clearTimeout(Y),i.textContent=s,i.className="toast-show "+d,Y=setTimeout(()=>{i.className=i.className.replace("toast-show","")},3e3))}function J(){let s=document.getElementById("bookmark-count");if(s){let d=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");s.textContent=d.length,s.style.display=d.length>0?"flex":"none"}}function _(){let s=document.getElementById("bookmark-list");if(!s)return;let d=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");s.innerHTML=d.length===0?"<li>Your watchlist is empty.</li>":d.map((i,h)=>`
      <li class="bookmark-item">
        <a href="${i.url}" class="bookmark-link">
          <img src="${i.poster||"https://i.imgur.com/YyHsyEr.png"}" alt="${i.title}" class="bookmark-thumb">
          <span class="bookmark-title">${i.title}</span>
        </a>
        <button class="delete-bookmark" data-index="${h}" title="Remove">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.84254 5.48939L8.52333 5.80406L7.84254 5.48939ZM8.81802 4.18112L8.31749 3.62258L8.31749 3.62258L8.81802 4.18112ZM10.2779 3.30696L10.5389 4.01009L10.2779 3.30696ZM13.7221 3.30696L13.9831 2.60384V2.60384L13.7221 3.30696ZM16.1575 5.48939L16.8383 5.17471L16.1575 5.48939ZM8.25 7.03259C8.25 6.61367 8.34194 6.19649 8.52333 5.80406L7.16175 5.17471C6.89085 5.76079 6.75 6.39238 6.75 7.03259H8.25ZM8.52333 5.80406C8.70487 5.41133 8.97357 5.04881 9.31855 4.73966L8.31749 3.62258C7.82675 4.06235 7.43251 4.58893 7.16175 5.17471L8.52333 5.80406ZM9.31855 4.73966C9.66369 4.43037 10.0778 4.18126 10.5389 4.01009L10.0169 2.60384C9.38616 2.83798 8.80808 3.18295 8.31749 3.62258L9.31855 4.73966ZM10.5389 4.01009C11.0001 3.8389 11.4968 3.75 12 3.75V2.25C11.3213 2.25 10.6477 2.36972 10.0169 2.60384L10.5389 4.01009ZM12 3.75C12.5032 3.75 12.9999 3.8389 13.4611 4.01009L13.9831 2.60384C13.3523 2.36972 12.6787 2.25 12 2.25V3.75ZM13.4611 4.01009C13.9222 4.18126 14.3363 4.43037 14.6815 4.73966L15.6825 3.62258C15.1919 3.18295 14.6138 2.83798 13.9831 2.60384L13.4611 4.01009ZM14.6815 4.73966C15.0264 5.04881 15.2951 5.41133 15.4767 5.80406L16.8383 5.17471C16.5675 4.58893 16.1733 4.06235 15.6825 3.62258L14.6815 4.73966ZM15.4767 5.80406C15.6581 6.19649 15.75 6.61367 15.75 7.03259H17.25C17.25 6.39238 17.1092 5.7608 16.8383 5.17471L15.4767 5.80406Z" fill="var(--keycolor)"></path><path d="M3 6.28259C2.58579 6.28259 2.25 6.61838 2.25 7.03259C2.25 7.44681 2.58579 7.78259 3 7.78259V6.28259ZM21 7.78259C21.4142 7.78259 21.75 7.44681 21.75 7.03259C21.75 6.61838 21.4142 6.28259 21 6.28259V7.78259ZM5 7.03259V6.28259H4.25V7.03259H5ZM19 7.03259H19.75V6.28259H19V7.03259ZM18.3418 16.8303L19.0624 17.0383L18.3418 16.8303ZM13.724 20.8553L13.8489 21.5949L13.724 20.8553ZM10.276 20.8553L10.401 20.1158L10.401 20.1158L10.276 20.8553ZM10.1183 20.8287L9.9933 21.5682L9.9933 21.5682L10.1183 20.8287ZM5.65815 16.8303L4.93757 17.0383L5.65815 16.8303ZM13.8817 20.8287L13.7568 20.0892L13.8817 20.8287ZM3 7.78259H21V6.28259H3V7.78259ZM13.7568 20.0892L13.599 20.1158L13.8489 21.5949L14.0067 21.5682L13.7568 20.0892ZM10.401 20.1158L10.2432 20.0892L9.9933 21.5682L10.151 21.5949L10.401 20.1158ZM18.25 7.03259V12.1758H19.75V7.03259H18.25ZM5.75 12.1759V7.03259H4.25V12.1759H5.75ZM18.25 12.1758C18.25 13.6806 18.0383 15.1776 17.6212 16.6223L19.0624 17.0383C19.5185 15.4583 19.75 13.8212 19.75 12.1758H18.25ZM13.599 20.1158C12.5404 20.2947 11.4596 20.2947 10.401 20.1158L10.151 21.5949C11.3751 21.8017 12.6248 21.8017 13.8489 21.5949L13.599 20.1158ZM10.2432 20.0892C8.40523 19.7786 6.90157 18.4335 6.37873 16.6223L4.93757 17.0383C5.61878 19.3981 7.58166 21.1607 9.9933 21.5682L10.2432 20.0892ZM6.37873 16.6223C5.9617 15.1776 5.75 13.6806 5.75 12.1759H4.25C4.25 13.8212 4.48148 15.4583 4.93757 17.0383L6.37873 16.6223ZM14.0067 21.5682C16.4183 21.1607 18.3812 19.3981 19.0624 17.0383L17.6212 16.6223C17.0984 18.4335 15.5947 19.7786 13.7568 20.0892L14.0067 21.5682ZM5 7.78259H19V6.28259H5V7.78259Z" fill="#6c6e76"></path><path d="M10 12V16M14 12V16" stroke="var(--keycolor)" stroke-width="1.5" stroke-linecap="round"></path></g></svg>
        </button>
      </li>`).join("")}let D=document.querySelector(".bookmark-btn"),C=document.getElementById("bookmark-modal");D&&C&&(D.addEventListener("click",s=>{s.preventDefault();let d=C.style.display==="block";C.style.display=d?"none":"block",d||_()}),document.addEventListener("click",s=>{C.style.display==="block"&&!C.contains(s.target)&&!D.contains(s.target)&&(C.style.display="none")}),C.addEventListener("click",s=>{let d=s.target.closest(".delete-bookmark");if(d){s.stopPropagation();let i=parseInt(d.getAttribute("data-index")),h=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");h.splice(i,1),localStorage.setItem("abefilm_bookmarks",JSON.stringify(h)),_(),J()}}));function z(s){let d=s.querySelector(".cast-scroll, .tmdb-row"),i=s.querySelector(".scroll-btn.left, .cast-scroll-btn.left, .tmdb-scroll.left"),h=s.querySelector(".scroll-btn.right, .cast-scroll-btn.right, .tmdb-scroll.right");if(!d||!i||!h)return;new ResizeObserver(()=>{if(!(d.scrollWidth>d.clientWidth+5)){i.style.display="none",h.style.display="none";return}let H=()=>{let O=Math.ceil(d.scrollLeft),F=d.scrollWidth-d.clientWidth;i.style.display=O>1?"flex":"none",h.style.display=O<F-1?"flex":"none"};d.addEventListener("scroll",H,{passive:!0}),H()}).observe(d)}function q(s){function d(w,I){let S="https://api.themoviedb.org/3/",T=new URL(S+w);return T.searchParams.set("api_key",I),T.searchParams.set("language","en-US"),T.toString()}function i(w,I){return w.media_type&&(w.media_type==="movie"||w.media_type==="tv")?w.media_type:I.startsWith("tv/")||I.startsWith("discover/tv")||I.startsWith("trending/tv")?"tv":"movie"}async function h(w,I){let S=document.getElementById("tmdb-slider"),T=document.getElementById("slider-dots"),Z=document.getElementById("slider-title");if(!S||!T||!Z)return;S.innerHTML="",T.innerHTML="";function B(a,u){return`https://api.themoviedb.org/3/${a}?api_key=${u}&language=en-US`}try{let p=function(e){o=e,j.forEach((l,b)=>l.style.display=b===e?"block":"none"),y.forEach((l,b)=>l.classList.toggle("active",b===e)),Z.textContent=v[e]||"",n&&clearInterval(n),n=setInterval(()=>m(1),5e3)},m=function(e){let l=(o+e+j.length)%j.length;p(l)};var k=p,c=m;let a=B(w,I),f=((await(await fetch(a)).json()).results||[]).slice(0,8);if(f.length===0){S.innerHTML="<p>No slider content found.</p>";return}let r=f.map(e=>{let l=e.media_type||(w.includes("tv")?"tv":"movie");return fetch(B(`${l}/${e.id}/images`,I)).then(b=>b.json())}),L=await Promise.all(r),v=[];f.forEach((e,l)=>{let b=e.media_type||(w.includes("tv")?"tv":"movie"),N=e.title||e.name||"Untitled",W=e.backdrop_path;if(!W)return;let U=L[l],ie=U.logos?.find(V=>V.iso_639_1==="en")||U.logos?.[0],ae=ie?`https://image.tmdb.org/t/p/w300${ie.file_path}`:"",te=`${window.location.origin}/p/details.html?id=${e.id}&type=${b}`,ne=document.createElement("a");ne.className="slide",ne.href=te,ne.style.backgroundImage=`url(https://image.tmdb.org/t/p/original${W})`,ne.innerHTML=`<div class="slide-caption">${ae?`<img class="logo-title" src="${ae}" alt="${N} Logo">`:`<h2>${N}</h2>`}</div>`,S.appendChild(ne),v.push(N);let oe=document.createElement("div");oe.className="thumbnail-dot",oe.setAttribute("data-index",l),oe.style.backgroundImage=`url(https://image.tmdb.org/t/p/w300${W})`,T.appendChild(oe)});let j=S.querySelectorAll(".slide"),y=T.querySelectorAll(".thumbnail-dot"),o=0,n;y.forEach((e,l)=>{e.addEventListener("click",()=>p(l))});let $=document.querySelector(".slider-arrow.left"),A=document.querySelector(".slider-arrow.right");$&&($.onclick=()=>m(-1)),A&&(A.onclick=()=>m(1)),j.length>0&&p(0);let M=0,t=0;S.addEventListener("touchstart",e=>{M=e.changedTouches[0].screenX},{passive:!0}),S.addEventListener("touchend",e=>{t=e.changedTouches[0].screenX,t<M-50&&m(1),t>M+50&&m(-1)},{passive:!0})}catch(a){console.error("Failed to load slider content:",a),S&&(S.innerHTML="<p style='color:red;'>Error loading slider.</p>")}}function E(w,I){document.querySelectorAll(".widget-content").forEach(S=>{let T=S.closest(".widget");if(!T||["HTML01","Text1","Text2"].includes(T.id))return;let Z=S.textContent.trim();if(!Z||Z.includes(" ")||Z.startsWith("http"))return;let B=document.createElement("div");B.className="tmdb-wrapper";let k=document.createElement("div");k.className="tmdb-row",k.innerHTML=[...Array(7)].map(()=>`<div class="tmdb-card shimmer-card"><div class="tmdb-thumb shimmer"><img src="${I}" class="tmdb-logo" alt="Logo" /></div><div class="tmdb-title shimmer"></div></div>`).join(""),B.appendChild(k),S.insertAdjacentElement("afterend",B),new IntersectionObserver(async(a,u)=>{for(let g of a)if(g.isIntersecting){u.unobserve(g.target);try{let f=new Promise(p=>setTimeout(p,500)),r=d(Z,w),L=fetch(r).then(p=>p.json()),[v,j]=await Promise.all([f,L]),y=j.results||[];if(y.length===0){k.innerHTML="<p>No results found.</p>";return}k.innerHTML=y.slice(0,14).map(p=>{let m=i(p,Z),$=p.title||p.name||"Untitled",A=p.poster_path;if(!A)return"";let M=(p.release_date||p.first_air_date||"").split("-")[0]||"N/A",t=p.vote_average?.toFixed(1)||"N/A",e=`${window.location.origin}/p/details.html?id=${p.id}&type=${m}`;return`<a class="tmdb-card" title="${$}" href="${e}"><div class="tmdb-thumb"><img src="https://image.tmdb.org/t/p/w300${A}" alt="${$}" loading="lazy" /><div class="hover-overlay"></div><span class="tmdb-meta tmdb-year">${M}</span><span class="tmdb-meta tmdb-rating"><i class="bi bi-star"></i> ${t}</span><div class="play-btn"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"/><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"/></svg></div></div><div class="tmdb-title">${$}</div></a>`}).join("");let o=document.createElement("button");o.className="tmdb-scroll left",o.innerHTML="&#8249;";let n=document.createElement("button");n.className="tmdb-scroll right",n.innerHTML="&#8250;",B.prepend(o),B.append(n),z(B)}catch(f){k.innerHTML="<p style='color:red;'>Failed to load data.</p>",console.error(f)}}},{threshold:.1,rootMargin:"150px 0px"}).observe(B)})}let x=document.querySelector("#Text1 .widget-content"),O=document.querySelector("#Text2 .widget-content")?.textContent.trim()||"",F=x?.textContent.trim();F&&h(F,apiKey),E(apiKey,O)}function G(s){let i=document.querySelector("#Text1 .widget-content")?.textContent.trim()||"https://api.themoviedb.org/3",h="https://image.tmdb.org/t/p/w500",E=new URLSearchParams(window.location.search),x=E.get("id"),H=E.get("type")||"movie",O=document.getElementById("movie-details-container"),F=1;async function w(){if(!x||!H){O.innerHTML="<p>Missing ID or type.</p>";return}try{let[c,a,u]=await Promise.all([fetch(`${i}/${H}/${x}?api_key=${s}&language=en-US`),fetch(`${i}/${H}/${x}/credits?api_key=${s}&language=en-US`),fetch(`${i}/${H}/${x}/${H==="movie"?"release_dates":"content_ratings"}?api_key=${s}`)]),g=await c.json(),f=await a.json(),r=await u.json(),L=I(H,r);S(g,f,L),H==="tv"?T(g.seasons):B(x),await k();let v=document.getElementById("cast-list");if(v&&f.cast?.length>0){let y=f.cast.slice(0,15).map(n=>`<div class="cast-card"><img src="${n.profile_path?h+n.profile_path:"https://i.imgur.com/obaaZjk.png"}" alt="${n.name}"><div>${n.name}</div><small>${n.character}</small></div>`).join(""),o=document.createElement("div");o.className="cast-scroll-wrapper",o.innerHTML=`<button class="scroll-btn left" aria-label="Scroll Left">\u2039</button><div class="cast-scroll">${y}</div><button class="scroll-btn right" aria-label="Scroll Right">\u203A</button>`,v.replaceWith(o),z(o)}let j=document.getElementById("user-reviews");try{let o=await(await fetch(`${i}/${H}/${x}/reviews?api_key=${s}&language=en-US`)).json();j&&(o.results&&o.results.length>0?j.innerHTML=o.results.slice(0,5).map(n=>{let p=n.author||"Anonymous",m=n.author_details?.avatar_path,$=m?m.startsWith("/https")?m.slice(1):`https://image.tmdb.org/t/p/w45${m}`:"https://ui-avatars.com/api/?name="+encodeURIComponent(p),A=new Date(n.created_at).toLocaleDateString();return`<div class="user-review"><div class="review-header"><img class="review-avatar" src="${$}" alt="${p}'s profile"><div><strong>${p}</strong><br><small>${A}</small></div></div><p class="review-content">${n.content.length>300?n.content.substring(0,300)+"...":n.content}</p></div>`}).join(""):j.innerHTML="<p>No user reviews available.</p>")}catch{j&&(j.innerHTML="<p>Failed to load user reviews.</p>")}}catch{O.innerHTML="<p>Error fetching details.</p>"}}function I(c,a){return c==="movie"?a.results?.find(g=>g.iso_3166_1==="US")?.release_dates?.[0]?.certification||"NR":a.results?.find(g=>g.iso_3166_1==="US")?.rating||"NR"}function S(c,a,u){let g=c.title||c.name,f=(c.release_date||c.first_air_date||"").split("-")[0]||"Unknown",r=c.genres?.map(m=>m.name).join("<span>|</span>")||"Unknown",L=c.vote_average?.toFixed(1)||"N/A",v=c.vote_count?.toLocaleString()||"0",j=c.overview||"No synopsis available.",y=c.poster_path?`${h}${c.poster_path}`:"https://i.imgur.com/YyHsyEr.png",o=c.backdrop_path?`https://image.tmdb.org/t/p/original${c.backdrop_path}`:"",n=c.origin_country?.[0]||c.production_countries?.[0]?.name||"Unknown",p=H==="tv"?"TV":"Movie";O.innerHTML=`<div class="detail-wrap"><div class="info-rating-wrapper"><div class="poster" style="--backdrop-url: url('${o}')"><img id="details-poster-img" data-main-poster="${y}" src="${y}" alt="${g}" /><div class="poster-play-btn" data-id="${x}" data-type="${H}" ${H==="tv"?'data-season="1"':""}><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="transparent"></path><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"></path></svg></div></div><div id="trailer-modal"><div id="modal-trailer-container"></div><div class="close-btn">&times;</div></div><div class="info"><h1 data-original-title="${g}">${g}</h1><div class="meta">${p} <span>|</span> ${f} <span>|</span> ${u} <span>|</span> ${n} <span>|</span> ${r}</div><p class="tagline">${j}</p><div class="buttons"><button class="watch" onclick="goToPlayer()"><i class="bi bi-play-fill"></i> Watch Now</button><button class="bookmark" onclick="bookmarkItem()"><i class="bi bi-bookmark"></i> Add to Watchlist</button><button class="share"><i class="bi bi-box-arrow-up-right"></i> Share</button></div></div><div class="rating"><i class="bi bi-star-fill"></i><strong>${L}</strong><span>/10</span><div class="vote-count">(${v} people rated)</div></div></div></div><div class="episode-placeholder" id="section-episodes"><h3>Episodes</h3><div class="episode-wrapper"><div id="season-buttons" class="season-wrap"></div><div id="episode-buttons" class="episode-wrap"></div></div></div><div class="details-extra-section"><div class="left-column"><div class="top-cast" id="section-cast"><h3>Top Cast</h3><div id="cast-list" class="cast-scroll"></div></div><div class="user-reviews"><h3>User Reviews</h3><div id="user-reviews" id="section-reviews"></div></div></div><div class="right-column"><h3>More Like This</h3><div id="more-like-grid" class="more-like-grid"></div></div></div>`}async function T(c){let a=document.getElementById("season-buttons");if(!a)return;a.innerHTML="",(c||[]).filter(f=>f.season_number!==0).forEach(f=>{let r=document.createElement("button");r.className="ep-btn season-btn",r.dataset.seasonNumber=f.season_number,r.dataset.airDate=f.air_date||"",r.dataset.posterPath=f.poster_path||"",r.textContent=`S${f.season_number}`,r.onclick=()=>{document.querySelectorAll(".season-btn").forEach(L=>L.classList.remove("active")),r.classList.add("active"),Z(r.dataset.seasonNumber,r.dataset.airDate,r.dataset.posterPath)},a.appendChild(r)});let g=a.querySelector(".season-btn");g&&g.click()}async function Z(c,a,u){F=c;let g=document.getElementById("episode-buttons"),f=document.querySelector(".info h1"),r=document.querySelector(".info .meta"),L=document.getElementById("details-poster-img"),v=document.querySelector(".poster-play-btn");if(v&&(v.dataset.season=c),f){let m=f.dataset.originalTitle||f.innerText.split(" S")[0];f.textContent=`${m} S${c}`}if(r&&a){let m=a.split("-")[0]||"N/A",$=r.innerHTML.split("<span>|</span>");$.length>1&&($[1]=` ${m} `,r.innerHTML=$.join("<span>|</span>"))}L&&(u&&u!=="null"?L.src=`${h}${u}`:L.src=L.dataset.mainPoster);let y=await(await fetch(`${i}/tv/${x}/season/${c}?api_key=${s}&language=en-US`)).json(),n=window.innerWidth<=600?14:35,p=(m,$=!1)=>{if(!g)return;if(g.innerHTML="",(($||(m||[]).length<=n?m:(m||[]).slice(0,n))||[]).forEach(M=>{let t=document.createElement("a");t.className="btn episode-btn",t.textContent=String(M.episode_number).padStart(2,"0"),t.href=`/p/player.html?id=${x}&type=tv&season=${c}&ep=${M.episode_number}`,g.appendChild(t)}),(m||[]).length>n){let M=document.createElement("button");M.className=`btn episode-btn ${$?"hide-btn":"show-more"}`,M.textContent=$?"Hide":"More",M.onclick=()=>p(y.episodes,!$),g.appendChild(M)}};y.episodes&&p(y.episodes,!1)}async function B(c){let a=document.getElementById("season-buttons"),u=document.getElementById("episode-buttons");a.innerHTML="",u.innerHTML="";let f=await(await fetch(`${i}/movie/${c}?api_key=${s}&language=en-US`)).json();if(f.belongs_to_collection)((await(await fetch(`https://api.themoviedb.org/3/collection/${f.belongs_to_collection.id}?api_key=${s}`)).json()).parts||[]).sort((y,o)=>new Date(y.release_date)-new Date(o.release_date)).forEach((y,o)=>{let n=document.createElement("a");n.className="ep-btn season-btn"+(y.id==c?" active":""),n.textContent=`Part ${o+1}`,n.href=`${window.location.origin}/p/details.html?id=${y.id}&type=movie`,a.appendChild(n)});else{let L=document.createElement("button");L.className="ep-btn season-btn active",L.textContent="S1",a.appendChild(L)}let r=document.createElement("a");r.className="btn episode-btn",r.textContent="01",r.href=`/p/player.html?id=${c}&type=movie`,u.appendChild(r)}async function k(){let c=document.getElementById("more-like-grid");c.innerHTML="";try{let u=await(await fetch(`${i}/${H}/${x}/recommendations?api_key=${s}&language=en-US`)).json();if(!u.results||u.results.length===0){c.innerHTML="<p>No recommendations available.</p>";return}u.results.slice(0,6).forEach(g=>{let f=document.createElement("a");f.href=`${window.location.origin}/p/details.html?id=${g.id}&type=${H}`,f.className="more-like-item abefilm-hover-card";let r=g.poster_path?`${h}${g.poster_path}`:"https://i.imgur.com/YyHsyEr.png";f.innerHTML=`<div class="abefilm-image-wrap"><img src="${r}" alt="${g.title||g.name}" onerror="this.src='https://i.imgur.com/YyHsyEr.png';"><div class="abefilm-hover-overlay"></div><div class="abefilm-play-button"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"></path><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"></path></svg></div></div><p>${g.title||g.name}</p>`,c.appendChild(f)})}catch{c.innerHTML="<p>Failed to load recommendations.</p>"}}window.goToPlayer=function(){let c=new URLSearchParams(window.location.search),a=c.get("id"),u=c.get("type");if(a&&u){let g=u==="tv"?`/p/player.html?id=${a}&type=tv&season=${F}&ep=1`:`/p/player.html?id=${a}&type=movie`;window.location.href=g}},window.bookmarkItem=function(){let c=new URLSearchParams(window.location.search),a=c.get("id"),u=c.get("type")||"movie",g=document.querySelector(".info h1")?.innerText,f=document.querySelector(".poster img")?.src;if(!a||!u||!g){P("Cannot add to watchlist: missing info.","info");return}let r=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");if(r.some(v=>v.id===a&&v.type===u)){P("Already on your watchlist","info");return}let L=`/p/details.html?id=${a}&type=${u}`;r.push({id:a,type:u,title:g,poster:f,url:L}),localStorage.setItem("abefilm_bookmarks",JSON.stringify(r)),P("Added to Watchlist","success"),J()},document.addEventListener("click",async function(c){if(c.target.closest(".poster-play-btn")){let a=c.target.closest(".poster-play-btn"),u=a.getAttribute("data-id"),g=a.getAttribute("data-type"),f=a.getAttribute("data-season"),r=document.getElementById("modal-trailer-container"),L=document.getElementById("trailer-modal");try{let v;g==="tv"&&f?v=`${i}/tv/${u}/season/${f}/videos?api_key=${s}&language=en-US`:v=`${i}/${g}/${u}/videos?api_key=${s}&language=en-US`;let y=await(await fetch(v)).json(),o=y.results.find(n=>n.type==="Trailer"&&n.site==="YouTube")||y.results.find(n=>n.type==="Teaser"&&n.site==="YouTube");o?r.innerHTML=`<iframe src="https://www.youtube.com/embed/${o.key}?autoplay=1" allowfullscreen allow="autoplay; encrypted-media" frameborder="0"></iframe>`:r.innerHTML="<p>No trailer found for this season.</p>",L.classList.add("active")}catch{r.innerHTML="<p>Error loading trailer.</p>",L.classList.add("active")}}if(c.target.closest(".share")){let a=window.location.href,u=document.querySelector(".info h1")?.innerText||"Check this out!";navigator.share?navigator.share({title:u,text:"Watch this online:",url:a}):navigator.clipboard.writeText(a).then(()=>P("Link copied!","success"),()=>prompt("Copy link:",a))}if(c.target.classList.contains("close-btn")){let a=document.getElementById("trailer-modal");a&&a.classList.remove("active");let u=document.getElementById("modal-trailer-container");u&&(u.innerHTML="")}}),w()}function ee(s){let d=new URLSearchParams(window.location.search),i=d.get("id"),h=d.get("type");if(!i||!h){document.body.innerHTML="<p style='color:white; text-align:center;'>Missing ID or type in URL.</p>";return}let E=`watch_state_${i}_${h}`;function x(o,n,p){let m={server:o,season:n,episode:p};localStorage.setItem(E,JSON.stringify(m))}function H(){let o=localStorage.getItem(E);return o?JSON.parse(o):null}function O(o,n,p){fetch(`https://api.themoviedb.org/3/${n}/${o}?api_key=${s}&language=en-US`).then(m=>m.json()).then(m=>{let $=m.title||m.name||"Untitled",A=n==="tv"?` S${p}`:"";document.title=`${$}${A} - Watch Now | AbeFilm`}).catch(m=>console.error("Title update failed:",m))}let F=document.getElementById("video-left"),w=document.getElementById("player-episode-buttons"),I=document.getElementById("server-buttons"),S=document.createElement("div");S.id="season-buttons",S.classList.add("season-button-container"),I&&I.insertAdjacentElement("afterend",S);let T=H(),Z=T?.season,B=parseInt(d.get("season")||Z||"1"),k=parseInt(d.get("ep")||T?.episode||"1"),c=T?.episode||k,a=T?.server||null,u={};function g(){let o=document.getElementById("video-sources");if(!o)return;o.querySelectorAll(".widget").forEach(p=>{let m=p.querySelector(".widget-title, .title")?.textContent.trim().toLowerCase(),$=p.querySelector(".widget-content")?.textContent.trim();if(m&&$){let A=$.split(`
`).map(e=>e.trim()).filter(Boolean),M=null,t=null;for(let e of A)/\${episode}/.test(e)?t=e:/\${id}/.test(e)&&(M=e);u[m]={movie:e=>M?M.replace(/\$\{id\}/g,e):"",tv:(e,l,b)=>t?t.replace(/\$\{id\}/g,e).replace(/\$\{season\}/g,l).replace(/\$\{episode\}/g,b):""}}})}function f(o=1){c=o;let n=u[a];if(!n||!F)return;let p=h==="movie"?n.movie(i):n.tv(i,B,o);F.innerHTML=p?`<iframe src="${p}" frameborder="0" allowfullscreen loading="lazy" style="width:100%;height:100%;max-height:100vh;"></iframe>`:"<p style='color:white'>Invalid or missing source URL.</p>"}function r(){I&&Object.keys(u).forEach(o=>{let n=document.createElement("button");n.textContent=o.toUpperCase(),n.className="server-btn",a||(a=o),o===a&&n.classList.add("active"),n.addEventListener("click",()=>{document.querySelectorAll(".server-btn").forEach(p=>p.classList.remove("active")),n.classList.add("active"),a=o,x(a,B,c),f(c)}),I.appendChild(n)})}function L(o){if(!w)return;w.innerHTML="";for(let m=1;m<=o;m++){let $=document.createElement("button");$.textContent=`${m}`,$.className="player-episode-btn",$.addEventListener("click",()=>{document.querySelectorAll(".player-episode-btn").forEach(A=>A.classList.remove("active")),$.classList.add("active"),x(a,B,m),f(m)}),w.appendChild($)}let n=w.querySelectorAll(".player-episode-btn"),p=n[k-1]||n[0];p&&p.classList.add("active"),f(k)}function v(){if(!w)return;w.innerHTML="";let o=document.createElement("button");o.textContent="1",o.className="player-episode-btn active",w.appendChild(o)}function j(o){let n=document.getElementById("footer-bottom");if(!n)return;let{title:p,name:m,overview:$,genres:A,status:M,vote_average:t,first_air_date:e,release_date:l,number_of_episodes:b}=o,N=b?"TV":"Movie",W=(l||e||"").split("-")[0];if(h==="tv"&&o?.seasons&&B){let V=o.seasons.find(X=>X.season_number==B);V?.air_date&&(W=V.air_date.split("-")[0])}let U=t?t.toFixed(1):"N/A",ie=A?.map(V=>V.name).join(", ")||"Unknown",ae=M||"Unknown",te=o.certification||o.content_ratings?.results?.find(V=>V.iso_3166_1==="US")?.rating||"NR";n.innerHTML=`<div class="footer-left"><div class="footer-title-rating"><strong>${p||m||"Untitled"}${b?` S${B}`:""} (${W})</strong></div><div class="footer-meta"><span class="footer-rating">\u2B50 ${U}</span><span class="type-meta">${N}</span> \u2022 <span>${ae}</span> \u2022 <span>Rated: ${te}</span></div><div class="footer-genres"><strong>Genres:</strong> ${ie}</div><div class="footer-overview">${$||"No overview available."}</div><span class="read-more-toggle">More</span></div><div class="footer-right"><h3>Recommended</h3><div class="recommendation-grid"></div></div>`;let ne=n.querySelector(".footer-overview"),oe=n.querySelector(".read-more-toggle");ne&&oe&&window.innerWidth<=768&&oe.addEventListener("click",()=>{ne.classList.toggle("expanded"),oe.textContent=ne.classList.contains("expanded")?"Less":"More"}),fetch(`https://api.themoviedb.org/3/${b?"tv":"movie"}/${o.id}/credits?api_key=${s}`).then(V=>V.json()).then(V=>{let X=V.cast?.slice(0,15);if(X?.length>0){let se=document.createElement("div");se.className="footer-cast-scroll-wrapper",se.innerHTML=`<h4>Cast</h4><div class="cast-scroll-wrapper"><button class="cast-scroll-btn left" aria-label="Scroll Left">\u2039</button><div class="cast-scroll">${X.map(re=>`<div class="cast-card"><img src="${re.profile_path?`https://image.tmdb.org/t/p/w185${re.profile_path}`:"https://i.imgur.com/obaaZjk.png"}" alt="${re.name}" onerror="this.onerror=null;this.src='https://i.imgur.com/obaaZjk.png';"><div class="cast-name">${re.name}</div><div class="cast-role">${re.character}</div></div>`).join("")}</div><button class="cast-scroll-btn right" aria-label="Scroll Right">\u203A</button></div>`,n.querySelector(".footer-left").appendChild(se),z(se.querySelector(".cast-scroll-wrapper"))}}).catch(V=>console.error("Cast Fetch Error:",V))}function y(o,n){let p=document.querySelector(".recommendation-grid");if(!p)return;let m=`https://api.themoviedb.org/3/${n}/${o}/recommendations?api_key=${s}`;fetch(m).then($=>$.json()).then($=>{let A=$.results?.slice(0,6);if(!A||A.length===0){p.innerHTML="<p style='color:#ccc'>No recommendations available.</p>";return}p.innerHTML=A.map(M=>{let t=M.title||M.name||"Untitled",e=M.poster_path?`https://image.tmdb.org/t/p/w185${M.poster_path}`:"https://i.imgur.com/YyHsyEr.png",l=M.media_type||(M.first_air_date?"tv":"movie");return`<div class="rec-item"><a href="/p/player.html?id=${M.id}&type=${l}"><div class="rec-thumb"><img src="${e}" alt="${t}" onerror="this.onerror=null;this.src='https://i.imgur.com/YyHsyEr.png';"><div class="abefilm-hover-overlay"></div><div class="abefilm-play-button"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"/><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"/></svg></div></div><span>${t}</span></a></div>`}).join("")}).catch($=>{console.error("Recommendation Fetch Error:",$),p.innerHTML="<p style='color:#ccc'>Failed to load recommendations.</p>"})}O(i,h,B),g(),Object.keys(u).length>0?(r(),f(c)):F&&(F.innerHTML="<p style='color:white'>No server templates found.</p>"),h==="tv"?(fetch(`https://api.themoviedb.org/3/tv/${i}?api_key=${s}`).then(o=>o.json()).then(o=>{j(o),y(o.id,h),o.seasons&&o.seasons.length>0&&S&&(S.innerHTML=o.seasons.filter(n=>n.season_number!==0).map(n=>`<a href="?id=${i}&type=tv&season=${n.season_number}" class="season-btn${n.season_number===B?" active":""}">${n.name}</a>`).join(""))}),fetch(`https://api.themoviedb.org/3/tv/${i}/season/${B}?api_key=${s}`).then(o=>o.json()).then(o=>{L(o.episodes?.length||0)})):h==="movie"&&(fetch(`https://api.themoviedb.org/3/movie/${i}?api_key=${s}`).then(o=>o.json()).then(o=>{j(o),y(o.id,h),o.belongs_to_collection?.id&&fetch(`https://api.themoviedb.org/3/collection/${o.belongs_to_collection.id}?api_key=${s}`).then(n=>n.json()).then(n=>{n.parts&&n.parts.length>1&&S&&(S.innerHTML=n.parts.sort((p,m)=>new Date(p.release_date)-new Date(m.release_date)).map((p,m)=>`<a href="?id=${p.id}&type=movie&part=${m+1}" class="season-btn${p.id==i?" active":""}">${"Part "+(m+1)}</a>`).join(""))})}),v(),f())}function Q(s){K(),J();let d=window.location.pathname,i=d.includes("/p/details.html"),h=d.includes("/p/player.html");i?G(s):h?ee(s):document.getElementById("tmdb-slider")&&q(s)}function R(){let s=0,d=50,i=setInterval(()=>{window.apiKey?(clearInterval(i),Q(window.apiKey)):s++>=d&&(clearInterval(i),console.error("FATAL: API Key (window.apiKey) was not found. App will not run."),[document.getElementById("tmdb-slider"),document.getElementById("movie-details-container"),document.getElementById("video-left")].forEach(E=>{E&&(E.innerHTML="<p style='color:red; text-align:center; padding: 2rem;'>Error: API configuration is missing.</p>")}))},100)}R()});document.addEventListener("DOMContentLoaded",function(){let Y=window.location.href,K=window.innerWidth<=768,P=location.origin+"/",J=location.pathname==="/"||location.pathname.endsWith("/index.html")||location.hostname.includes("blogspot.com")&&!location.pathname.includes("/p/"),_=Y.includes("/p/details.html"),D=Y.includes("/p/player.html"),C=Y.includes("/p/library.html"),z=Y.includes("/p/about-us.html"),q=Y.includes("/p/privacy-policy.html"),G=Y.includes("/p/disclaimer.html"),ee=document.querySelector("#Text12 .widget-content"),Q=document.querySelector("#Text13 .widget-content"),R=document.querySelector("#Text14 .widget-content"),s=document.querySelector("footer .website-name"),d=document.querySelector("footer .website-description"),i=document.querySelector("footer .credit");if(ee&&s&&(s.innerHTML=ee.innerHTML),Q&&d&&(d.innerHTML=Q.innerHTML),R&&i){i.innerHTML=R.innerHTML;let r=i.querySelector("#currentYear");r&&(r.textContent=new Date().getFullYear())}let h=document.getElementById("about-us"),E=document.getElementById("privacy-policy"),x=document.getElementById("disclaimer"),H=document.querySelector("#Text10 .widget-content"),O=document.querySelector("#Text9 .widget-content"),F=document.querySelector("#Text11 .widget-content");z&&h&&H&&(h.innerHTML=H.innerHTML),q&&E&&O&&(E.innerHTML=O.innerHTML),G&&x&&F&&(x.innerHTML=F.innerHTML);let w=document.getElementById("details-content"),I=document.getElementById("player-content"),S=document.getElementById("library");w&&(w.style.display=_?"block":"none"),I&&(I.style.display=D?"block":"none"),S&&(S.style.display=C?"block":"none"),h&&(h.style.display=z?"block":"none"),E&&(E.style.display=q?"block":"none"),x&&(x.style.display=G?"block":"none"),D&&(document.querySelector(".top-header")?.remove(),document.querySelector(".side-menu")?.remove()),C&&K&&document.querySelector(".top-header")?.remove();let T={home:"tmdb-section-1",movies:"tmdb-section-2",tvseries:"tmdb-section-3",animation:"tmdb-section-4",kdramas:"tmdb-section-5",cdramas:"tmdb-section-6",anime:"tmdb-section-7","western-movies":"tmdb-section-8","western-series":"tmdb-section-9"};if(document.querySelectorAll('.side-menu a[href^="#"], .bottom-navbar a[href^="#"], .anchor-links a[href^="#"]').forEach(r=>{r.addEventListener("click",function(L){J||(L.preventDefault(),window.location.href=P+this.getAttribute("href"))})}),!J&&location.hash&&T[location.hash.replace("#","")]){window.location.href=P+location.hash;return}if(J){let r=()=>{let L=window.location.hash.replace("#","")||"home";Object.entries(T).forEach(([v,j])=>{let y=document.getElementById(j);y&&(y.style.display=v===L?"block":"none")}),document.querySelectorAll(".side-menu a, .bottom-navbar a, .anchor-links a").forEach(v=>{let j=v.getAttribute("href")?.replace("#","");v.classList.toggle("active",j===L)})};r(),window.addEventListener("hashchange",r)}let Z;function B(r,L="info"){let v=document.getElementById("custom-toast-notification");v||(v=document.createElement("div"),v.id="custom-toast-notification",document.body.appendChild(v)),clearTimeout(Z),v.textContent=r,v.className="toast-show "+L,Z=setTimeout(()=>{v.className=v.className.replace("toast-show","")},3e3)}let k=document.querySelector(".top-header");if(k){let r=()=>{J&&!K?k.classList.toggle("scrolled",window.scrollY>100):K||k.classList.add("scrolled")};window.addEventListener("scroll",r),r()}let c=document.getElementById("toggleSidebar"),a=document.getElementById("mobileSidebar"),u=document.getElementById("sidebarOverlay");c&&a&&u&&(c.addEventListener("click",()=>{a.classList.toggle("active"),u.style.display=a.classList.contains("active")?"block":"none"}),u.addEventListener("click",()=>{a.classList.remove("active"),u.style.display="none"})),document.querySelector(".share-btn")?.addEventListener("click",()=>{navigator.share?navigator.share({title:document.title,url:window.location.href}).catch(r=>console.warn("Share failed:",r)):navigator.clipboard.writeText(window.location.href).then(()=>B("Link copied to clipboard!","success")).catch(()=>B("Could not copy link.","error"))}),document.querySelector(".top-btn")?.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),document.querySelector(".back-history")?.addEventListener("click",r=>{r.preventDefault(),window.history.length>1?window.history.back():window.location.href="/"});let g=document.getElementById("comment-nav-button"),f=document.getElementById("comment-section");g&&f&&g.addEventListener("click",r=>{r.preventDefault(),f.scrollIntoView({behavior:"smooth",block:"start"})})});document.addEventListener("DOMContentLoaded",()=>{if(!document.getElementById("comment-section"))return;let{createClient:K}=supabase,_=K("https://hwucnfgzeghfmagromyb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3dWNuZmd6ZWdoZm1hZ3JvbXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MzUwMjMsImV4cCI6MjA3MDIxMTAyM30.Sl8JjfFj9iEWZxwun9XzaZeQcEN1BtfcU2FmlGdemI8"),D=new URLSearchParams(window.location.search),C=D.get("id"),z=D.get("type"),q=C&&z?`${z}-${C}`:window.location.pathname,G=document.getElementById("authModal"),ee=document.getElementById("closeAuthModalBtn"),Q=document.getElementById("showAuthModalBtn"),R=document.getElementById("loginPrompt"),s=document.getElementById("commentFormContainer"),d=document.getElementById("message"),i=document.getElementById("submit"),h=document.getElementById("logoutBtn"),E=document.getElementById("avatarModal"),x=document.getElementById("closeAvatarModalBtn"),H=document.getElementById("currentUserAvatar"),O=document.getElementById("currentUsernameDisplay"),F=document.getElementById("saveAvatarBtn"),w=null,I="https://cdn-icons-png.flaticon.com/128/1046/1046929.png",S=!0,T=!1,Z={},B={person:["https://cdn-icons-png.flaticon.com/128/4139/4139981.png","https://cdn-icons-png.flaticon.com/128/4140/4140057.png","https://cdn-icons-png.flaticon.com/128/4140/4140077.png","https://cdn-icons-png.flaticon.com/128/2202/2202112.png","https://cdn-icons-png.flaticon.com/128/4140/4140061.png","https://cdn-icons-png.flaticon.com/128/4140/4140037.png","https://cdn-icons-png.flaticon.com/128/4140/4140051.png","https://cdn-icons-png.flaticon.com/128/4139/4139951.png","https://cdn-icons-png.flaticon.com/128/4140/4140060.png","https://cdn-icons-png.flaticon.com/128/6997/6997662.png","https://cdn-icons-png.flaticon.com/128/4140/4140040.png","https://cdn-icons-png.flaticon.com/128/4140/4140047.png"],animal:["https://cdn-icons-png.flaticon.com/128/4322/4322991.png","https://cdn-icons-png.flaticon.com/128/4775/4775614.png","https://cdn-icons-png.flaticon.com/128/4775/4775640.png","https://cdn-icons-png.flaticon.com/128/1326/1326390.png","https://cdn-icons-png.flaticon.com/128/9308/9308861.png","https://cdn-icons-png.flaticon.com/128/9308/9308872.png","https://cdn-icons-png.flaticon.com/128/1326/1326415.png","https://cdn-icons-png.flaticon.com/128/9308/9308930.png","https://cdn-icons-png.flaticon.com/128/1760/1760998.png","https://cdn-icons-png.flaticon.com/128/1326/1326401.png","https://cdn-icons-png.flaticon.com/128/4775/4775517.png","https://cdn-icons-png.flaticon.com/128/9308/9308916.png","https://cdn-icons-png.flaticon.com/128/3940/3940435.png","https://cdn-icons-png.flaticon.com/128/6740/6740990.png","https://cdn-icons-png.flaticon.com/128/4775/4775608.png","https://cdn-icons-png.flaticon.com/128/1005/1005364.png","https://cdn-icons-png.flaticon.com/128/6740/6740990.png","https://cdn-icons-png.flaticon.com/128/4775/4775608.png"],animation:["https://i.pinimg.com/1200x/f5/44/96/f544962a7b3129c0637ac2ae3822ce04.jpg","https://i.pinimg.com/1200x/17/86/c4/1786c496eb64a64f81181de49638d713.jpg","https://i.pinimg.com/736x/6d/d0/73/6dd073b2fa2e8e85b3667f76a233300c.jpg","https://i.pinimg.com/736x/0b/41/df/0b41dff69b51c42493489ed10eada7ee.jpg","https://i.pinimg.com/1200x/57/c4/ac/57c4acf284c8278a97dd862b90d0a7f6.jpg","https://i.pinimg.com/736x/8b/38/fe/8b38fe784ebdef337b2e5925e849b865.jpg","https://i.pinimg.com/736x/f7/2c/d1/f72cd11d081fda86f6defac97834fa6a.jpg","https://i.pinimg.com/736x/22/dc/88/22dc88835f11c148a26724be02ba37d6.jpg","https://i.pinimg.com/736x/08/97/a3/0897a36b7d6da0a57ee8a1fed7f67bbc.jpg","https://i.pinimg.com/736x/4f/50/5b/4f505b0e22c2fb9de8df11606d63aee3.jpg","https://i.pinimg.com/1200x/cf/40/37/cf40375b3ad057d3b6759fd7b5cfc69b.jpg","https://i.pinimg.com/736x/21/da/6a/21da6af1a11272715f67c3d5ccac4941.jpg","https://i.pinimg.com/736x/71/d8/00/71d8003e7580495d0bafd80eccd3b3c0.jpg","https://i.pinimg.com/736x/be/38/78/be3878c34f93d1663a6e5f6af4b78e9c.jpg","https://i.pinimg.com/736x/33/3d/d0/333dd06be42713804de17ae38caa0680.jpg","https://i.pinimg.com/1200x/dc/89/44/dc8944d0b4f1174080edb5bb66e97eaf.jpg","https://i.pinimg.com/736x/a7/6e/32/a76e3272f50feb992792ee874910d233.jpg","https://i.pinimg.com/1200x/77/70/3f/77703fafc70fcf5e37089acd53fd514a.jpg"],emoji:["https://i.pinimg.com/736x/5b/8b/26/5b8b26358e27e259ca5b308adb0007d9.jpg","https://i.pinimg.com/1200x/4e/ed/e3/4eede304ca4f6bfcc857e9343c33fc95.jpg","https://i.pinimg.com/1200x/15/e8/32/15e832be938d0e6ed7266bf789d71bb7.jpg","https://i.pinimg.com/1200x/87/a6/a3/87a6a35d663a034c38bdf8b7be022acd.jpg","https://i.pinimg.com/1200x/43/27/bd/4327bd2cf07e8311bcf05fce38aedc9a.jpg","https://i.pinimg.com/1200x/08/16/61/081661bd0bf7ec4b45d4fc3dd820a60f.jpg","https://i.pinimg.com/1200x/23/c0/06/23c00684fe980429026b8d012e64f25c.jpg","https://i.pinimg.com/1200x/2a/34/06/2a3406c7a142f9173536f3f7d744edc5.jpg","https://i.pinimg.com/736x/9e/f1/84/9ef1846a74700af02e30898ff0e4b730.jpg","https://i.pinimg.com/736x/8b/43/0a/8b430af942a8482b1b817a38725adc18.jpg","https://i.pinimg.com/736x/53/ea/b3/53eab3d0b5babe47d2808e8353176127.jpg","https://i.pinimg.com/1200x/b1/7f/b5/b17fb561e2092833380731bc6553fa1f.jpg","https://i.pinimg.com/736x/ff/67/8e/ff678e727c07cd355797551d5f468f89.jpg","https://i.pinimg.com/736x/2e/f4/33/2ef433ecf11c3c52d21c83e0a8a05f2c.jpg","https://i.pinimg.com/736x/ea/98/95/ea989550c5533f9682859bd79fc6be01.jpg","https://i.pinimg.com/1200x/0e/68/de/0e68de2be0c8f1ddd5fe87aa3ca304d7.jpg","https://i.pinimg.com/1200x/6c/a9/4b/6ca94b596e161af20fe4738eadf18eef.jpg","https://i.pinimg.com/1200x/ca/f2/ee/caf2ee640db02286ed2c3617178ec958.jpg"]};async function k(){if(!q||q===window.location.pathname)return;let{data:t,error:e}=await _.from("reactions").select("*").eq("topic",q).single();if(e&&e.code==="PGRST116"){let{data:l,error:b}=await _.from("reactions").insert({topic:q,upvote:0,funny:0,love:0,surprised:0,angry:0,sad:0}).select().single();if(b){console.error("Error creating reaction entry:",b);return}t=l}else if(e){console.error("Error fetching reactions:",e);return}Z=t,c()}function c(){if(!Z)return;let t=0;Object.keys(Z).forEach(l=>{if(["topic","id","created_at"].includes(l))return;let b=Z[l]||0,N=document.getElementById(`${l}-count`);N&&(N.textContent=b,t+=b)}),document.getElementById("totalResponses").textContent=t;let e=localStorage.getItem(q);document.querySelectorAll(".reaction").forEach(l=>{l.classList.toggle("reacted",l.dataset.reaction===e)})}async function a(t){if(T||!q)return;T=!0;let e=localStorage.getItem(q),l;e===t?(localStorage.removeItem(q),l=_.rpc("decrement_reaction",{topic_name:q,reaction_name:t})):e?(localStorage.setItem(q,t),l=_.rpc("switch_reaction",{topic_name:q,old_reaction_name:e,new_reaction_name:t})):(localStorage.setItem(q,t),l=_.rpc("increment_reaction",{topic_name:q,reaction_name:t}));let{error:b}=await l;b&&(console.error("Failed to update reaction:",b),e?localStorage.setItem(q,e):localStorage.removeItem(q)),await k(),T=!1}async function u(t){if(w=t?.user||null,w){R.style.display="none",s.style.display="block";let e=w.user_metadata?.username||(w.is_anonymous?"Guest User":w.email);O.textContent=e,I=w.user_metadata?.profile_url||"https://cdn-icons-png.flaticon.com/128/1046/1046929.png",H.src=I}else R.style.display="block",s.style.display="none";A()}_.auth.onAuthStateChange((t,e)=>{u(e)}),document.getElementById("signInBtn").addEventListener("click",async()=>{let t=document.getElementById("loginEmail").value,e=document.getElementById("loginPassword").value,{error:l}=await _.auth.signInWithPassword({email:t,password:e});l?alert(l.message):G.style.display="none"}),document.getElementById("signUpBtn").addEventListener("click",async()=>{let t=document.getElementById("signupEmail").value,e=document.getElementById("signupPassword").value,l=document.getElementById("signupUsername").value.trim();if(!l)return alert("Please enter a display name for signup.");let{data:b,error:N}=await _.auth.signUp({email:t,password:e,options:{data:{username:l,profile_url:"https://cdn-icons-png.flaticon.com/128/1046/1046929.png"}}});N?alert(N.message):b.user&&(alert("Signed up successfully! Please check your email to confirm your account."),G.style.display="none")}),document.getElementById("guestSignInBtn").addEventListener("click",async()=>{let{data:t,error:e}=await _.auth.signInAnonymously();e?(console.error("GUEST SIGN-IN FAILED:",e),alert(e.message)):G.style.display="none"}),h.addEventListener("click",async()=>{let{error:t}=await _.auth.signOut();t&&alert(t.message)});function g(){G.style.display=G.style.display==="block"?"none":"block",r("login")}function f(){E.style.display=E.style.display==="block"?"none":"block",document.querySelectorAll("#avatarModal .tab-content img").forEach(e=>e.classList.remove("selected"));let t=document.querySelector(`#avatarModal img[src="${I}"]`);t&&t.classList.add("selected")}function r(t){document.querySelectorAll("#authModal .tab-content").forEach(e=>e.classList.remove("active")),document.getElementById(t).classList.add("active"),document.querySelectorAll("#authModal .tab-btn").forEach(e=>e.classList.remove("active")),document.querySelector(`#authModal .tab-btn[data-tab="${t}"]`).classList.add("active")}function L(t){document.querySelectorAll("#avatarModal .tab-content").forEach(l=>l.classList.remove("active")),document.getElementById(t).classList.add("active"),document.querySelectorAll("#avatarModal .tab-btn").forEach(l=>l.classList.remove("active")),document.querySelector(`#avatarModal .tab-btn[data-tab="${t}"]`).classList.add("active")}Q.addEventListener("click",g),ee.addEventListener("click",g),x.addEventListener("click",f),H.addEventListener("click",f),document.querySelectorAll("#authModal .tab-btn").forEach(t=>t.addEventListener("click",()=>r(t.dataset.tab))),document.querySelectorAll("#avatarModal .tab-btn").forEach(t=>t.addEventListener("click",()=>L(t.dataset.tab)));function v(){Object.entries(B).forEach(([t,e])=>{let l=document.getElementById(t);l&&(l.innerHTML="",e.forEach(b=>{let N=document.createElement("img");N.src=b,N.addEventListener("click",()=>{document.querySelectorAll("#avatarModal .tab-content img").forEach(W=>W.classList.remove("selected")),N.classList.add("selected"),I=b}),l.appendChild(N)}))})}F.addEventListener("click",async()=>{if(!w)return alert("You must be logged in to save an avatar.");let{data:t,error:e}=await _.auth.updateUser({data:{profile_url:I}});e?alert("Error saving avatar: "+e.message):(t.user&&(w.user_metadata.profile_url=t.user.user_metadata.profile_url,H.src=t.user.user_metadata.profile_url),f(),alert("Avatar saved successfully!"))});async function j(){let{data:{user:t}}=await _.auth.getUser();if(!t)return g();let e=d.value.trim(),l=t.user_metadata?.username||t.email;t.is_anonymous&&(l="Guest User");let b=t.user_metadata?.profile_url||I;if(!e)return alert("Message is required.");let N={user_id:t.id,username:l,message:e,profile_url:b,created_at:new Date().toISOString(),likes:0,dislikes:0,emoji:null,topic:q},{error:W}=await _.from("comments").insert([N]);W?(console.error("DATABASE ERROR:",W),alert("Could not post comment. See console for details.")):(d.value="",A())}i.addEventListener("click",j);async function y(t,e){let{data:{user:l}}=await _.auth.getUser();if(!l)return g();let b=l.user_metadata?.username||l.email;l.is_anonymous&&(b="Guest User");let N=l.user_metadata?.profile_url||I,{error:W}=await _.from("comments").insert([{user_id:l.id,username:b,message:e,profile_url:N,created_at:new Date().toISOString(),parent_id:t,likes:0,dislikes:0,emoji:null,topic:q}]);W?(console.error("DATABASE ERROR on reply:",W),alert("Error submitting reply. See console for details.")):A()}function o(t){let e=new Date(t),b=Math.floor((new Date-e)/1e3);return b<60?`${b}s ago`:b<3600?`${Math.floor(b/60)}m ago`:b<86400?`${Math.floor(b/3600)}h ago`:`${Math.floor(b/86400)}d ago`}let n=document.getElementById("customSortDropdown"),p=n.querySelector(".selected-option"),m=n.querySelector(".dropdown-options");p.addEventListener("click",()=>{m.style.display=m.style.display==="block"?"none":"block"}),m.querySelectorAll("li").forEach(t=>{t.addEventListener("click",()=>{m.querySelectorAll("li").forEach(e=>e.classList.remove("active")),t.classList.add("active"),p.innerText=t.innerText,m.style.display="none",S=t.dataset.value==="recent",A()})}),document.addEventListener("click",t=>{n.contains(t.target)||(m.style.display="none")});async function $(t,e){let{data:{user:l}}=await _.auth.getUser();if(!l)return g();let{data:b,error:N}=await _.from("comments").select(e).eq("id",t).single();if(N){console.error(`Error fetching ${e} count:`,N);return}let W=(b[e]||0)+1,{error:U}=await _.from("comments").update({[e]:W}).eq("id",t);U?(console.error(`Error updating ${e} count:`,U),alert(`Could not update ${e}. See console for details.`)):A()}async function A(){let{data:t,error:e}=await _.from("comments").select("*").eq("topic",q).order("created_at",{ascending:!S});if(e){if(e.code==="PGRST116"){document.getElementById("comments-list").innerHTML="",document.getElementById("commentCount").innerText=0;return}return console.error("Error loading comments:",e)}let l=document.getElementById("comments-list");l.innerHTML="";let b=t.filter(U=>!U.parent_id),N=t.filter(U=>U.parent_id),W=(U,ie=!1)=>{let ae=1,te=document.createElement("div"),ne=N.some(X=>X.parent_id===U.id),oe=ie?"comment reply-box":"comment";ne||(oe+=" no-replies"),te.className=oe,te.innerHTML=`
              <div class="comment-header">
                <img src="${U.profile_url}" />
                <div><strong>${U.username}</strong> <small>${o(U.created_at)}</small></div>
              </div>
              <div class="comment-body">${U.message}</div>
              <div class="comment-footer">
                <span class="like-btn" data-id="${U.id}"><i class="bi bi-hand-thumbs-up"></i> <span class="like-count">${U.likes||0}</span></span>
                <span class="dislike-btn" data-id="${U.id}"><i class="bi bi-hand-thumbs-down"></i> <span class="dislike-count">${U.dislikes||0}</span></span>
                <span class="reply-btn" data-id="${U.id}"><i class="bi bi-chat-left-text"></i> Reply</span>
              </div>
              <div class="replies"></div>`;let V=te.querySelector(".replies");return te.querySelector(".like-btn").addEventListener("click",()=>$(U.id,"likes")),te.querySelector(".dislike-btn").addEventListener("click",()=>$(U.id,"dislikes")),te.querySelector(".reply-btn").addEventListener("click",()=>{if(V.innerHTML="",!w)return g();let X=document.createElement("div");X.innerHTML=`<textarea placeholder="What's on your mind?" class="reply-message"></textarea><button class="comment-btn reply-submit">Submit Reply</button>`,V.appendChild(X),X.querySelector(".reply-submit").addEventListener("click",async()=>{let se=X.querySelector(".reply-message").value.trim();se?await y(U.id,se):alert("Reply message required")})}),N.filter(X=>X.parent_id===U.id).forEach(X=>{let se=W(X,!0);se.classList.add(`reply-${ae++}`),V.appendChild(se)}),te};document.getElementById("commentCount").innerText=t.length,b.forEach(U=>l.appendChild(W(U))),M()}function M(){document.querySelectorAll(".comment.reply-box.last-reply").forEach(t=>{t.classList.remove("last-reply")}),document.querySelectorAll(".replies").forEach(t=>{let e=t.querySelectorAll(".comment.reply-box");e.length>0&&e[e.length-1].classList.add("last-reply")})}(async()=>{v(),await k();let{data:{session:t}}=await _.auth.getSession();await u(t),document.querySelectorAll(".reaction").forEach(e=>{e.addEventListener("click",()=>a(e.dataset.reaction))})})()});(function(){let Y="https://ebswuixgklryutksfavw.supabase.co",K="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVic3d1aXhna2xyeXV0a3NmYXZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTEwNTgsImV4cCI6MjA3MDQ4NzA1OH0.fFie0cVqkHsZsiqOArnUECt-FaahQ4kIPB5rcYEpNlg",P="https://abefilm.github.io/MOVIEBOX-TMDB/";function J(D){if(!D)return"";let C=D.trim();return C=C.replace(/^(https?:\/\/)?/i,""),C=C.replace(/\/+$/,""),C=C.split("?")[0],C}async function _(){let D=J(window.location.hostname),C=[D];D.startsWith("www.")&&C.push(D.replace("www.",""));try{let z=`domain=in.(${C.map(d=>`"${d}"`).join(",")})`,q=`${Y}/rest/v1/licenses?${z}&select=*`,G=await fetch(q,{headers:{apikey:K,Authorization:`Bearer ${K}`}});if(!G.ok)throw new Error(`Supabase returned status: ${G.status}`);let ee=await G.json();if(!ee||ee.length===0){console.error(`License check failed: No valid license found for "${D}". Redirecting.`),window.location.href=P;return}let Q=ee[0],R=new Date,s=new Date(Q.expiry_date);if(s.setDate(s.getDate()+1),Q.status!=="forever"&&s<R){console.error(`License expired on: ${Q.expiry_date}. Redirecting.`),window.location.href=P;return}console.log(`\u2705 License valid for ${D} | Expires: ${Q.expiry_date} | Status: ${Q.status}`)}catch(z){console.error("License check process failed:",z),window.location.href=P}}_()})();})();
